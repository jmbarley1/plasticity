---
title: "Phenotypic Plasticity Meta-analysis"
author: "Jordanna Barley and Morgan Kelly"
date: "11/24/2020"
output: word_document
---

```{r setup, include=FALSE, warning=FALSE}
require(knitr)
knitr::opts_chunk$set(echo = F, message = F, warning = F)
require(here)
require(readxl)
require(tidyverse)
require(plotrix)
require(metafor)
limit<-read.csv(here('Data','limit_data2_updated.csv'))
acc<-read_xlsx(here('Data', 'acc_data_reformatted.xlsx'))
filter=dplyr::filter

local({
  if(knitr::is_latex_output()) {
  plot_default <- knit_hooks$get("plot")
  knit_hooks$set(plot = function(x, options) { 
    x <- c(plot_default(x, options), "\\vspace{13pt}" )
  })
  }
})

str(acc)
acc$ecosystem<- factor(acc$ecosystem)
acc$phylum<- factor(acc$phylum)
acc$acclimation_temperature_1<-factor(acc$acclimation_temperature_1)
acc$acclimation_temperature_2<-factor(acc$acclimation_temperature_2)
acc$thermal_limit_1<-as.numeric(acc$thermal_limit_1)
acc$thermal_limit_2<-as.numeric(acc$thermal_limit_2)
acc$thermal_limit_error_type<-factor(acc$thermal_limit_error_type)
acc$thermal_limit_error_1<-as.numeric(acc$thermal_limit_error_1)
acc$thermal_limit_error_2<-as.numeric(acc$thermal_limit_error_2)
acc$upper_lower<-factor(acc$upper_lower)
```
### Introduction and Rationale

The purpose of this document is to detail the exploratory data analysis of the phenotypic plasticity meta-analysis. This work is important because it is not currently known how plasticity varies within speices across latitude and ecosystem. Because different populations of the same species are often locally adapted to their locale, it is important to understand how plasticity varies within species' population as well as across species and ecosystem. 

## Data screening, extraction, and structure

# Data Screening

**We include 30 studies in our analysis.**

To find studies relevent to this project, we searched Web o Science using this search string:

>(Thermal OR temperatures) AND (Lethal OR "Thermal tolerance" OR "Thermal limit*" OR CTmax OR CTmin OR LT50 OR "freezing >tolerance") AND ("Local* Adapt*" OR ""Latitud* Var*" OR Intraspecific)

Literature searches were conducted on August 24th, 2019 and July 28th, 2020. In addition, we added studies that were not returned in the searches via Web of Sciences were included when they met the criteria. 

Studies returned from the literature search were screened based on these criteria:
*Study presents new results (not a review paper)
*Study reports upper or lower thermal limits in degrees C
*Study reports the same thermal limit metric for at least two populations of the same species, as defined by the study authors
*Must be able to determine geographic coordinates of origin for each population
*Study uses whole-organism measurements of thermal limits, with the exception of electrolyte leakage for plants
*Studies must report sample size and some measure of variance for thermal limit measurements
*Measurements reported cannot come from hybrid lines, cultivars, domesticated species, or later generations of experimental evolution projects
*Measurement were made on individuals that had been acclimated under common conditions for the same amount of time
*Studies must have experimentally measured thermal tolerance after acclimating individuals from all populations to 2 or more temperatures for the same amount of time
*Populations of the same species cannot be from different ecosystems (marine, terrestrial, intertidal, or freshwater)

# Data extraction

taxon: scientific name of focal species
*ecosystem: freshwater, intertidal, ocean, or terrestrial
*dispersal_mode: planktonic, direct developer, and NA (for terrestrial taxa). If unsure, use “uncertain” • acclimation_time number of generations organisms reared for, <1 for within generation study
*year: year collection / experiments occurred
*latitude: decimal degrees
*longitude: decimal degrees
*life_history_stage: self
*sex: self
*acclimation_temperature_1: temperature (degrees C) of the lowest temperature used in experiment to compare to all other acclimation temperatures
*acclimation_temperature_2: temperature (degrees C) this is not the lowest temperature used (i.e. higher temps being compared to lowest acclimation temperature)
*measurement_level: describes whether limit measurements were made on individuals or populations • thermal_limit_type: methodology used to estimate thermal limit
*thermal_limit_: mean thermal limit (degrees C) for each population at the lowest acclimation temperature
*thermal_limit_2: mean thermal limit (degrees C) for each population for the acclimation temperatures that are not the lowest (to be compared to thermal_limit_1)
*thermal_limit_error_type: measure used to describe spread for thermal limit
*thermal_limit_error_1: reported error of thermal_limit_1
*thermal_limit_error_2: reported error of thermal_limit_2
*n: sample size measured as the number of independent estimates of thermal limits

Plots showing the number of studies per ecosystem and the type of data we get from each:
```{r, EDA plots, echo=FALSE, warning=FALSE}
#studies per ecosystem
acc %>% 
  group_by(study, ecosystem) %>% 
  summarise(mean=mean(thermal_limit_1)) %>% 
  group_by(ecosystem) %>% 
  summarise(n_studies=n()) %>% 
  ggplot(aes(x=ecosystem, y=n_studies, fill=ecosystem))+
  geom_bar(stat='identity')+
  theme_classic()+
  xlab('Ecosystem')+
  ylab('Number of studies')

#studies with upper and lower limits
acc %>% 
  group_by(study, thermal_limit_type) %>% 
  summarise(mean=mean(thermal_limit_1)) %>% 
  group_by(thermal_limit_type) %>% 
  summarise(n_studies=n()) %>% 
  ggplot(aes(x=thermal_limit_type, y=n_studies))+
  geom_bar(stat='identity')+
  theme_classic()+
  scale_y_continuous(breaks = c(0,2,4,6,8,10,12, 14, 16, 18, 20))+
  ylab('Number of studies')+
  xlab('Thermal Limit Type')
```
**Note: while there are 9 studies that use LT50, only 2 of them are missing estimates of variance**

```{r,pops_per_study, echo=FALSE, warning=FALSE}
#how many populations does each study have?
acc %>% 
  group_by(study, taxon, ecosystem) %>% 
  summarise(n_pops=mean(number_of_populations)) %>% 
  ggplot(aes(x=study, y=n_pops, fill=ecosystem))+
  geom_bar(stat='identity')+
  coord_flip()+
  xlab('Number of populations')+
  ylab('Study')
```
*Note: Armstrong et al. 2020 includes two species, which is why their population count is so high

```{r, EDA plots cont., echo=FALSE, warning=FALSE}

#Number of acc temps per study
acc %>% 
  group_by(study, acclimation_temperature_1, ecosystem) %>% 
  summarise(mean=mean(thermal_limit_1)) %>% 
  group_by(study, ecosystem) %>% 
  summarise(n_acc=n()) %>% 
  mutate(n_acc2=n_acc+1) %>% 
  ggplot(aes(x=n_acc2, y=study, fill=ecosystem))+
  geom_bar(stat='identity')+
  xlab('Number of acclimation temperatures')
  
```
**Note: the average number of acclimation temperatures per study is 2.63.**

```{r, EDA plots cont2, echo=FALSE, warning=FALSE}
#acclimation temp difference per study
acc$acclimation_temperature_1<-as.numeric(as.character(acc$acclimation_temperature_1))
acc$acclimation_temperature_2<-as.numeric(as.character(acc$acclimation_temperature_2)) 

acc %>% 
  select(study, ecosystem, acclimation_temperature_1, acclimation_temperature_2) %>% 
  mutate(acc_diff = acclimation_temperature_2 - acclimation_temperature_1) %>% 
  group_by(study, ecosystem) %>% 
  mutate(max_diff=max(acc_diff)) %>% 
  group_by(study, ecosystem) %>% 
  summarise(mean_diff=mean(max_diff)) %>% 
  ggplot(aes(x=study, y=mean_diff, fill=ecosystem))+
  geom_bar(stat='identity')+
  coord_flip()+
  ylab('Maximum difference in acclimation temp (C)')
```

```{r, table of studies, echo=FALSE, warning=FALSE}
#full table of studies
kable(acc %>% 
  group_by(study, source_population, ecosystem, thermal_limit_type, acclimation_temperature_1) %>% 
  summarize(mean=mean(thermal_limit_1)) %>% 
  group_by(study,ecosystem, thermal_limit_type, acclimation_temperature_1) %>% 
  summarise(n_pop=n()) %>% 
  group_by(study, ecosystem, thermal_limit_type, n_pop) %>% 
  summarise(n_temp=n()) %>% 
  mutate(n_temp2=n_temp+1) %>% 
  select(study, ecosystem, thermal_limit_type, n_pop, n_temp2) %>% 
  rename(Study=study, Ecosystem=ecosystem, Thermal_limit_type=thermal_limit_type, Number_pops=n_pop, Number_acctemps=n_temp2)
)
```

```{r, error type, echo=FALSE, warning=FALSE}
kable(acc %>% 
  group_by(study, thermal_limit_error_type) %>%
  summarise(mean=mean(thermal_limit_1)) %>% 
  select(-mean)
)
```


To quantify thermal plasticity, we will be calculating acclimation response ratio (ARR) by taking the different of the limits divided by the difference in acclimation temperature: 
(limit2-limit1)/(temp2-temp1)

Here is the distribution of ARR:
```{r ARR distribution, echo=FALSE}
acc<- acc %>% 
  mutate(ARR=(thermal_limit_2-thermal_limit_1)/(acclimation_temperature_2-acclimation_temperature_1))

acc %>% 
  ggplot(aes(x=ARR))+
  geom_histogram(bins=40)

acc %>% 
  dplyr::filter(ecosystem!='terrestrial') %>%  
  ggplot(aes(x=ARR))+
  geom_histogram(bins=40)+
  facet_wrap(~ecosystem)+
  theme_classic()

##distribution of ARRs for terrestrial ecosystems
acc %>% 
  dplyr::filter(ecosystem=='terrestrial') %>% 
  ggplot(aes(x=ARR))+
  geom_histogram(bins = 40)+
  theme_classic()+
  ggtitle('Terrestrial')

acc %>% 
  filter(upper_lower== 'upper') %>% 
  ggplot(aes(x=ARR))+
  geom_histogram(bins=40)+
  facet_wrap(~ecosystem)+
  theme_classic()+
  ggtitle('Upper Limits')

acc %>% 
  filter(upper_lower== 'lower') %>% 
  ggplot(aes(x=ARR))+
  geom_histogram(bins=40)+
  facet_wrap(~ecosystem)+
  theme_classic()+
  ggtitle('Lower Limits')
```

A look at mean ARR across ecosystem:
```{r, mean ARR across ecosystem, echo=FALSE}
#bar plot
acc %>% 
  group_by(ecosystem) %>% 
  summarise(mean=mean(ARR), sd=std.error(ARR)) %>% 
  ggplot(aes(x=ecosystem, y=mean, fill=ecosystem))+
  geom_bar(stat = 'identity')+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  ylab('Mean Acclimation Response Ratio')+
  xlab('Ecosystem')+
  theme_classic()+
  theme(legend.position='none')

#boxplot
acc %>% 
  ggplot(aes(x=ecosystem, y=ARR, fill=ecosystem))+
  geom_boxplot()+
  theme_classic()
```

ARR versus latitude:
```{r, ARR vs Latitude, echo=FALSE}
acc<-acc %>% 
    mutate(abs_lat=abs(latitude))
acc %>% 
  ggplot(aes(x=abs_lat, y=ARR, color=ecosystem))+
  geom_point(position = position_jitter(width=1), alpha=0.5)+
  geom_smooth(method = lm)+
  xlab('Absolute Latitude')+
  theme_classic()

acc %>% 
  filter(upper_lower== 'upper') %>%
  ggplot(aes(x=abs_lat, y=ARR, color=ecosystem))+
  geom_point()+
  theme_classic()+
  geom_smooth(method = lm)+
  xlab('Absolute Latitude')+
  ggtitle('Upper Limits')

acc %>% 
  filter(upper_lower== 'lower') %>%
  ggplot(aes(x=abs_lat, y=ARR, color=ecosystem))+
  geom_point()+
  theme_classic()+
  geom_smooth(method = lm)+
  xlab('Absolute Latitude')+
  ggtitle('Lower Limits')
  
```

ARR versus thermal limit: 
```{r, ARR vs thermal limit, echo=FALSE}
acc %>% 
  ggplot(aes(x=thermal_limit_1, y=ARR, color=ecosystem))+
  geom_point()+
  geom_smooth(method = lm)+
  theme_classic()+
  xlab('Thermal Limit (\u00B0C)')+
  ggtitle('All data')

#upper limits
acc %>% 
  filter(thermal_limit_1>20) %>% 
  ggplot(aes(x=thermal_limit_1, y=ARR, color=ecosystem))+
  geom_point()+
  geom_smooth(method = lm)+
  theme_classic()+
  xlab('Thermal Limit (\u00B0C)')+
  ggtitle('Upper Limits')

#lower limits
acc %>% filter(thermal_limit_1<20) %>% 
  ggplot(aes(x=thermal_limit_1, y=ARR, color=ecosystem))+
  geom_point()+
  geom_smooth(method = lm)+
  theme_classic()+
  xlab('Thermal Limit (\u00B0C)')+
  ggtitle('Lower Limits')
```



























